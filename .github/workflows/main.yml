# æ·»åŠ æ’­æ”¾æ¥å£å¤‡ä»½åœ°å€https://github.com/ne7359/MyALL/blob/main/TVBox/mytvbox/publish/App.java
#sed -i 's/versionName "[0-9]*\.[0-9]*\.[0-9]*"/&.QTM.${{ env.bteme }})/' app/build.gradle  # åœ¨ç‰ˆæœ¬"éšæœº"è¡Œæœªæ·»åŠ .QTM Build
#"assembleMobileJavaX86Release",
#"assembleMobilePythonX86Release",
#"assembleLeanbackJavaX86Release",
#"assembleLeanbackJavaX86Release"],
name: box
on:
  workflow_dispatch:
    inputs:
      user_godown:
        description: "é€‰æ‹© TV æºåˆ†æ”¯"
        required: false
        default: "FongMi/TV"
        type: choice
        options:
          - FongMi/TV
          - okcaptain/TV
          - jadehh/FongMiTV
          - LyOuYang/TV
      source_branch:
        description: "é€‰æ‹© TV åˆ†æ”¯"
        required: false
        default: "release"
        type: choice
        options:
          - release
          - dev
          - fongmi
          - kitkat
env:
    GITHUB_WORKSPACE: ${{ github.workspace }}

jobs:
  build:
    name: framework:${{ matrix.framework}})
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
    strategy:
      fail-fast: false
      matrix:
        framework: ["assembleLeanbackJavaArm64_v8aRelease",
                    "assembleLeanbackJavaArmeabi_v7aRelease",
                    "assembleLeanbackPythonArm64_v8aRelease",
                    "assembleLeanbackPythonArmeabi_v7aRelease",
                    "assembleMobileJavaArm64_v8aRelease",
                    "assembleMobileJavaArmeabi_v7aRelease",
                    "assembleMobilePythonArm64_v8aRelease",
                    "assembleMobilePythonArmeabi_v7aRelease"]
    steps:
      - name: è®¾ç½®å¼€å§‹æ—¶é—´
        run: |
          echo "VERSION=$(curl -s "https://raw.githubusercontent.com/${{ inputs.user_godown }}/${{ inputs.source_branch }}/app/build.gradle" | grep 'versionName' | cut -d\" -f2)" >> $GITHUB_ENV
          echo 'è¯»å–æºç‰ˆæœ¬ä¿¡æ¯å®Œæˆ'
          START_TIME=`date +'%Y-%m-%d %H:%M:%S'`
          echo "START_SECONDS=$(date --date="$START_TIME" +%s)" >> $GITHUB_ENV
          echo "è®¾ç½®å¼€å§‹æ—¶é—´å®Œæˆ"

      - name: è¯»å–mytvboxæ•°æ®
        uses: actions/checkout@v4
        with:
          repository: ne7359/mytvbox
          ref: publish
          path: code

      - name: è¯»å–TVæºæ•°æ®
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.user_godown }}
          ref: ${{ inputs.source_branch }}
          path: tv

      - name: diy
        working-directory: tv
        run: |
          sed -i 's/versionName "[0-9]*\.[0-9]*\.[0-9]*"/versionName "QTM Build v${{ env.bteme }}"/g' app/build.gradle
          echo 'ç‰ˆæœ¬å·æ›´æ”¹å®Œæˆ'
          chmod +x $GITHUB_WORKSPACE/code/date.sh
          $GITHUB_WORKSPACE/code/date.sh


      - name: å®‰è£… Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: å®‰è£… Gradle
        uses: gradle/actions/setup-gradle@v3
        
      - name: ç”¨ Gradle æ„å»º apk
        working-directory: tv
        run: |
          bash gradlew ${{ matrix.framework}}
 
      - name: ç¼–è¯‘å®Œæˆæ—¶é—´
        run: |
          echo "ç¼–è¯‘å®Œæˆæ—¶é—´..."
          START_SECONDS=${{ env.START_SECONDS }}
          END_TIME=`date +'%Y-%m-%d %H:%M:%S'`
          END_SECONDS=$(date --date="$END_TIME" +%s)
          SECONDS=$((END_SECONDS-START_SECONDS))
          HOUR=$(( $SECONDS/3600 )) && MIN=$(( ($SECONDS-${HOUR}*3600)/60 )) && SEC=$(( $SECONDS-${HOUR}*3600-${MIN}*60 ))
          echo "BUILD_TIME=${HOUR}æ—¶${MIN}åˆ†${SEC}ç§’" >> $GITHUB_ENV
          find tv/app/build/outputs/apk/ -name '*.apk' -exec echo {} \;
 
      - name: ç¼–è¯‘å®Œæˆæ—¶é—´
        run: |
          echo -e "ğŸˆ ç¼–è¯‘æ—¶é—´ï¼š${{ env.tag }}\\n\\nâ° ç¼–è¯‘ç”¨æ—¶ï¼š${{ env.BUILD_TIME }}\\n\\nâ˜… æºç åˆ†æ”¯ï¼š${{ inputs.user_godown }} - ${{ inputs.source_branch }} v${{ env.VERSION }}\\n\\n--- " >> ${{ github.workspace }}-CHANGELOG.txt
          echo -e "å‡çº§ä¿¡æ¯" >> ${{ github.workspace }}-CHANGELOG.txt
          if [ "${{ inputs.source_branch }}" = "release" ]; then
            echo "$(curl -s 'https://raw.githubusercontent.com/FongMi/Release/main/apk/release/leanback.json' | jq -r '.desc')" >> $GITHUB_WORKSPACE/CHANGELOG.txt
          elif [ "${{ inputs.source_branch }}" = "fongmi" ]; then
            echo "$(curl -s 'https://raw.githubusercontent.com/FongMi/Release/fongmi/apk/release/leanback.json' | jq -r '.desc')" >> $GITHUB_WORKSPACE/CHANGELOG.txt
          else
            echo "æ²¡æœ‰åŒ¹é…é€€å‡ºå†™CHANGELOG.txt"
          fi
          
      - name: ä¸Šä¼ åˆ°å‘å¸ƒ
        uses: softprops/action-gh-release@v2
        with:
          name: QTMå½±è§†
          tag_name: ${{ env.tag }}
          body_path: ${{ github.workspace }}-CHANGELOG.txt
          files: ./tv/app/build/outputs/apk/*/release/*.apk
        env:
          GITHUB_TOKEN: ${{ github.token }} # ç»™æœ€é«˜çš„æƒé™
