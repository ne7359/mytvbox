# 添加播放接口备份地址https://github.com/ne7359/MyALL/blob/main/TVBox/mytvbox/publish/App.java
#sed -i 's/versionName "[0-9]*\.[0-9]*\.[0-9]*"/&.QTM.${{ env.bteme }})/' app/build.gradle  # 在版本"随机"行未添加.QTM Build
#"assembleMobileJavaX86Release",
#"assembleMobilePythonX86Release",
#"assembleLeanbackJavaX86Release",
#"assembleLeanbackJavaX86Release"],
name: box
on:
  workflow_dispatch:
    inputs:
      user_godown:
        description: "选择 TV 源分支"
        required: false
        default: "FongMi/TV"
        type: choice
        options:
          - FongMi/TV
          - okcaptain/TV
          - jadehh/FongMiTV
          - LyOuYang/TV
      source_branch:
        description: "选择 TV 分支"
        required: false
        default: "release"
        type: choice
        options:
          - release
          - dev
          - fongmi
          - kitkat
env:
    GITHUB_WORKSPACE: ${{ github.workspace }}

jobs:
  build:
    name: framework:${{ matrix.framework}})
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
    strategy:
      fail-fast: false
      matrix:
        framework: ["assembleLeanbackJavaArm64_v8aRelease",
                    "assembleLeanbackJavaArmeabi_v7aRelease",
                    "assembleLeanbackPythonArm64_v8aRelease",
                    "assembleLeanbackPythonArmeabi_v7aRelease",
                    "assembleMobileJavaArm64_v8aRelease",
                    "assembleMobileJavaArmeabi_v7aRelease",
                    "assembleMobilePythonArm64_v8aRelease",
                    "assembleMobilePythonArmeabi_v7aRelease"]
    steps:
      - name: 设置开始时间
        run: |
          echo "VERSION=$(curl -s "https://raw.githubusercontent.com/${{ inputs.user_godown }}/${{ inputs.source_branch }}/app/build.gradle" | grep 'versionName' | cut -d\" -f2)" >> $GITHUB_ENV
          echo '读取源版本信息完成'
          START_TIME=`date +'%Y-%m-%d %H:%M:%S'`
          echo "START_SECONDS=$(date --date="$START_TIME" +%s)" >> $GITHUB_ENV
          echo "设置开始时间完成"

      - name: 读取mytvbox数据
        uses: actions/checkout@v4
        with:
          repository: ne7359/mytvbox
          ref: publish
          path: code

      - name: 读取TV源数据
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.user_godown }}
          ref: ${{ inputs.source_branch }}
          path: tv

      - name: diy
        working-directory: tv
        run: |
          sed -i 's/versionName "[0-9]*\.[0-9]*\.[0-9]*"/versionName "QTM Build v${{ env.bteme }}"/g' app/build.gradle
          echo '版本号更改完成'
          chmod +x $GITHUB_WORKSPACE/code/date.sh
          $GITHUB_WORKSPACE/code/date.sh


      - name: 安装 Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: 安装 Gradle
        uses: gradle/actions/setup-gradle@v3
        
      - name: 用 Gradle 构建 apk
        working-directory: tv
        run: |
          bash gradlew ${{ matrix.framework}}
 
      - name: 编译完成时间
        run: |
          echo "编译完成时间..."
          START_SECONDS=${{ env.START_SECONDS }}
          END_TIME=`date +'%Y-%m-%d %H:%M:%S'`
          END_SECONDS=$(date --date="$END_TIME" +%s)
          SECONDS=$((END_SECONDS-START_SECONDS))
          HOUR=$(( $SECONDS/3600 )) && MIN=$(( ($SECONDS-${HOUR}*3600)/60 )) && SEC=$(( $SECONDS-${HOUR}*3600-${MIN}*60 ))
          echo "BUILD_TIME=${HOUR}时${MIN}分${SEC}秒" >> $GITHUB_ENV
          find tv/app/build/outputs/apk/ -name '*.apk' -exec echo {} \;
 
      - name: 编译完成时间
        run: |
          echo -e "🎈 编译时间：${{ env.tag }}\\n\\n⏰ 编译用时：${{ env.BUILD_TIME }}\\n\\n★ 源码分支：${{ inputs.user_godown }} - ${{ inputs.source_branch }} v${{ env.VERSION }}\\n\\n--- " >> ${{ github.workspace }}-CHANGELOG.txt
          echo -e "升级信息" >> ${{ github.workspace }}-CHANGELOG.txt
          if [ "${{ inputs.source_branch }}" = "release" ]; then
            echo "$(curl -s 'https://raw.githubusercontent.com/FongMi/Release/main/apk/release/leanback.json' | jq -r '.desc')" >> $GITHUB_WORKSPACE/CHANGELOG.txt
          elif [ "${{ inputs.source_branch }}" = "fongmi" ]; then
            echo "$(curl -s 'https://raw.githubusercontent.com/FongMi/Release/fongmi/apk/release/leanback.json' | jq -r '.desc')" >> $GITHUB_WORKSPACE/CHANGELOG.txt
          else
            echo "没有匹配退出写CHANGELOG.txt"
          fi
          
      - name: 上传到发布
        uses: softprops/action-gh-release@v2
        with:
          name: QTM影视
          tag_name: ${{ env.tag }}
          body_path: ${{ github.workspace }}-CHANGELOG.txt
          files: ./tv/app/build/outputs/apk/*/release/*.apk
        env:
          GITHUB_TOKEN: ${{ github.token }} # 给最高的权限
